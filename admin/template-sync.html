<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resulta Admin - Template Sync</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#E91E63',
          }
        }
      }
    }
  </script>
  <style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    /* Google Fonts Autocomplete */
    .autocomplete-container {
      position: relative;
    }
    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 50;
      margin-top: 4px;
    }
    .dark .autocomplete-dropdown {
      background: #374151;
      border-color: #4b5563;
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .autocomplete-item:hover {
      background: #f3f4f6;
    }
    .dark .autocomplete-item:hover {
      background: #4b5563;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
  
  <!-- Password Protection Overlay -->
  <div id="authOverlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">üîê Admin Access</h2>
      <form id="authForm">
        <input 
          type="password" 
          id="passwordInput"
          placeholder="Enter password"
          class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary transition mb-4"
          autofocus
        >
        <button 
          type="submit"
          class="w-full py-3 px-6 rounded-lg bg-primary hover:bg-pink-600 text-white font-semibold transition"
        >
          Access Admin
        </button>
        <p id="authError" class="hidden mt-3 text-red-500 text-sm text-center">Incorrect password</p>
      </form>
    </div>
  </div>

  <!-- Main Content (hidden until authenticated) -->
  <div id="mainContent" class="hidden">
    <div class="max-w-xl mx-auto p-6">
      
      <!-- Header with Navigation -->
      <div class="mb-6 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Template Sync</h1>
          <p class="text-sm text-gray-500 dark:text-gray-400">Add or update templates from Templated.io</p>
        </div>
        <a href="fonts.html" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium transition">
          üî§ Manage Fonts
        </a>
      </div>

      <!-- Mode Toggle -->
      <div class="flex gap-2 mb-6">
        <button 
          onclick="setMode('new')" 
          id="modeNewBtn"
          class="flex-1 py-3 px-4 rounded-lg font-medium transition-all border-2 border-primary bg-primary/10 text-primary"
        >
          + New Template
        </button>
        <button 
          onclick="setMode('existing')" 
          id="modeExistingBtn"
          class="flex-1 py-3 px-4 rounded-lg font-medium transition-all border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400"
        >
          Update Existing
        </button>
      </div>

      <!-- Main Form -->
      <form id="mainForm" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 space-y-5">
        
        <!-- Templated ID (always visible) -->
        <div id="templatedIdSection">
          <label for="templated_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Templated ID <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-2">
            <input 
              type="text" 
              id="templated_id" 
              required
              placeholder="e.g., e56ddb13-f39d-4b4b-a2aa-1586c5e17273"
              class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary transition"
            >
            <button 
              type="button" 
              id="fetchInfoBtn"
              onclick="fetchTemplateInfo()"
              class="px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm transition flex items-center gap-2"
            >
              <svg id="fetchInfoSpinner" class="hidden animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span id="fetchInfoText">Fetch Info</span>
            </button>
          </div>
          <p id="templatedIdHint" class="mt-1 text-xs text-gray-500">From Templated.io URL or API</p>
          <!-- Existing template info (shown when found in update mode) -->
          <div id="existingTemplateInfo" class="hidden mt-2 p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
            <p class="text-sm text-blue-700 dark:text-blue-300">
              <span class="font-medium">Found:</span> <span id="existingTemplateName"></span>
            </p>
            <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
              Canvas: <span id="existingTemplateSize"></span>
            </p>
          </div>
        </div>
        
        <!-- Fonts Found in Template (shown after Fetch Info) -->
        <div id="fontsFoundSection" class="hidden border border-green-200 dark:border-green-800 rounded-lg p-4 bg-green-50 dark:bg-green-900/20">
          <div class="flex items-center justify-between mb-3">
            <p class="font-medium text-gray-700 dark:text-gray-300">üî§ Fonts Found in Template</p>
            <span id="fontsFoundCount" class="text-xs px-2 py-1 rounded-full bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200">0 fonts</span>
          </div>
          <p class="text-xs text-gray-500 mb-3">Link each font to a Google Font for proper rendering. If the font is custom, leave blank and upload later.</p>
          <div id="fontsFoundList" class="space-y-3">
            <!-- Font items will be inserted here -->
          </div>
        </div>

        <!-- Template Name -->
        <div id="nameSection">
          <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Template Name <span id="nameRequired" class="text-red-500">*</span>
            <span id="nameOptionalHint" class="hidden text-xs text-gray-500 font-normal ml-2">(optional - leave blank to keep existing)</span>
          </label>
          <input 
            type="text" 
            id="name" 
            placeholder="e.g., Story-BeforeAfter-Beige"
            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary transition"
          >
        </div>

        <!-- Canvas Size (hidden in update mode) -->
        <div id="canvasSizeSection">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Canvas Size <span class="text-red-500">*</span>
          </label>
          <div class="grid grid-cols-3 gap-2 mb-2">
            <button type="button" onclick="setPreset(1080, 1350, this)" class="preset-btn py-2 rounded-lg border-2 border-primary bg-primary/10 text-primary font-medium text-sm">
              4:5 <span class="text-xs opacity-75 block">1080√ó1350</span>
            </button>
            <button type="button" onclick="setPreset(1080, 1080, this)" class="preset-btn py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-medium text-sm">
              1:1 <span class="text-xs opacity-75 block">1080√ó1080</span>
            </button>
            <button type="button" onclick="setPreset(1080, 1920, this)" class="preset-btn py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-medium text-sm">
              9:16 <span class="text-xs opacity-75 block">1080√ó1920</span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input type="number" id="canvas_width" value="1080" min="100" max="4096" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
            <input type="number" id="canvas_height" value="1350" min="100" max="4096" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
          </div>
        </div>

        <!-- Default Colors Section -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-5">
          <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">üé® Background & Colors</p>
          
          <!-- Background Type Selector -->
          <div class="mb-4">
            <label class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2 block">Background Type</label>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" onclick="setBackgroundType('original')" id="bgTypeOriginal" class="bg-type-btn py-2 px-3 rounded-lg border-2 border-primary bg-primary/10 text-primary font-medium text-sm flex items-center justify-center gap-2">
                üñºÔ∏è Original
                <span class="text-xs opacity-75 block">(Image/Texture)</span>
              </button>
              <button type="button" onclick="setBackgroundType('color')" id="bgTypeColor" class="bg-type-btn py-2 px-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-medium text-sm flex items-center justify-center gap-2">
                üé® Solid Color
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              <strong>Original:</strong> Keep image/texture background from Templated.io
            </p>
          </div>
          
          <!-- Background Color (shown only when solid color is selected) -->
          <div id="bgColorSection" class="hidden mb-3">
            <div class="flex items-center gap-3">
              <input type="color" id="default_bg_color" value="#FFFFFF" class="w-10 h-10 rounded border-2 border-gray-300 cursor-pointer">
              <div class="flex-1">
                <label class="text-xs font-medium text-gray-600 dark:text-gray-400">
                  Background Color
                  <span class="text-green-600 text-xs ml-1">(auto-fetched from Templated.io if left as #FFFFFF)</span>
                </label>
                <input type="text" id="default_bg_color_hex" value="#FFFFFF" placeholder="#FFFFFF" class="w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm font-mono">
              </div>
            </div>
          </div>
          
          <!-- Theme Color -->
          <div class="flex items-center gap-3">
            <input type="color" id="default_theme_color" value="#303030" class="w-10 h-10 rounded border-2 border-purple-300 cursor-pointer">
            <div class="flex-1">
              <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Theme Color <span class="text-purple-500">(for theme-* layers)</span></label>
              <input type="text" id="default_theme_color_hex" value="#303030" placeholder="#303030 or leave empty" class="w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm font-mono">
            </div>
          </div>
          
          <p class="text-xs text-gray-500 mt-2">
            <strong>Theme:</strong> Applied to layers with "theme-" prefix. Users can change colors in the app.
          </p>
        </div>

        <!-- Text Transform Section -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-5">
          <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">üî§ Text Transform</p>
          <div>
            <label for="default_text_transform" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">
              Default Text Transform
            </label>
            <select 
              id="default_text_transform" 
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition"
            >
              <option value="none">None (use original casing from template)</option>
              <option value="uppercase">UPPERCASE</option>
              <option value="lowercase">lowercase</option>
              <option value="capitalize">Capitalize Each Word</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">
              Controls how text casing is transformed in the template. Useful if Templated.io text doesn't match your design.
            </p>
          </div>
        </div>

        <!-- Active Toggle -->
        <div class="flex items-center gap-2">
          <input type="checkbox" id="is_active" checked class="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
          <label for="is_active" class="text-sm text-gray-700 dark:text-gray-300">Active (visible in app)</label>
        </div>

        <!-- Skip Thumbnail Toggle (faster sync) - only for new templates -->
        <div id="fastSyncSection" class="flex items-center gap-2 border-t border-gray-200 dark:border-gray-700 pt-4">
          <input type="checkbox" id="skip_thumbnail" checked class="w-5 h-5 rounded border-gray-300 text-purple-500 focus:ring-purple-500">
          <label for="skip_thumbnail" class="text-sm text-gray-700 dark:text-gray-300">
            <span class="font-medium">Fast sync</span> 
            <span class="text-xs text-gray-500">(use Templated.io preview, skip thumbnail generation)</span>
          </label>
        </div>
        <p id="updateThumbnailNote" class="hidden text-xs text-green-600 border-t border-gray-200 dark:border-gray-700 pt-4">
          ‚úÖ Thumbnail will be regenerated automatically when updating
        </p>

        <!-- Submit Button -->
        <button 
          type="submit" 
          id="submitBtn"
          class="w-full py-4 px-6 rounded-xl bg-primary hover:bg-pink-600 text-white font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2"
        >
          <span id="btnText">Sync & Generate</span>
          <svg id="btnSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>

      <!-- Status Message -->
      <div id="statusMessage" class="hidden mt-6"></div>

      <!-- Font Status (shown after sync) -->
      <div id="fontStatus" class="hidden mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-3">üî§ Font Status</p>
        <div id="fontStatusContent"></div>
      </div>

      <!-- Batch Thumbnail Regeneration -->
      <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-3">üñºÔ∏è Batch Thumbnail Regeneration</p>
        <p class="text-xs text-gray-500 mb-3">Regenerate thumbnails for all templates with their default background and theme colors.</p>
        <button 
          type="button" 
          onclick="regenerateAllThumbnails()"
          id="batchBtn"
          class="w-full py-3 px-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-medium transition-all flex items-center justify-center gap-2"
        >
          <span id="batchBtnText">Regenerate All Thumbnails</span>
          <svg id="batchSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
        <div id="batchStatus" class="hidden mt-3 text-sm"></div>
      </div>

      <!-- Layer Naming Quick Reference (Collapsed) -->
      <details class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <summary class="font-medium text-gray-700 dark:text-gray-300 cursor-pointer">üìã Layer Naming Convention (STRICT)</summary>
        <div class="mt-3 text-xs space-y-2 text-gray-600 dark:text-gray-400">
          <p><code class="bg-green-100 dark:bg-green-900 px-1 rounded">slot-*</code> ‚Üí Photo placeholders (hidden in PNG, app renders user photos)</p>
          <p><code class="bg-purple-100 dark:bg-purple-900 px-1 rounded">theme-*</code> ‚Üí Color-changeable layers (hidden in PNG, app renders with theme color)</p>
          <p><code class="bg-blue-100 dark:bg-blue-900 px-1 rounded">vector</code> type ‚Üí SVG icons/shapes (hidden in PNG, app renders as SVG)</p>
          <p><strong>Everything else</strong> ‚Üí Static content (stays in frame overlay PNG as-is)</p>
          <hr class="my-2 border-gray-300 dark:border-gray-600">
          <p class="font-medium">‚ö†Ô∏è STRICT PREFIX MATCHING:</p>
          <p>‚Ä¢ Use <code>slot-</code> prefix (not just "slot" anywhere in name)</p>
          <p>‚Ä¢ Use <code>theme-</code> prefix (not just "theme" anywhere in name)</p>
          <p>‚Ä¢ No hardcoded background layer names - background transparency via API option</p>
        </div>
      </details>

    </div>
  </div>

  <script>
    // Configuration
    const ADMIN_PASSWORD = 'adminpanel123';
    const WEBHOOK_URL = 'https://jackhunterking.app.n8n.cloud/webhook/sync-template';
    const SUPABASE_URL = 'https://tmgjsrxdjbazrwvbdoed.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtZ2pzcnhkamJhenJ3dmJkb2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDE3MDcsImV4cCI6MjA4MzMxNzcwN30.krSbo9fqvKkbQrjFDnQo2s7JiaXwo1wydhvaontxtFE';
    const FRAME_OVERLAY_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/generate-frame-overlay`;
    const THUMBNAIL_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/generate-thumbnail`;

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Templated.io API (for fetching template layers)
    const TEMPLATED_API_KEY = 'b0b73cf7dd304321c9eed6ad0ad4303ab21b1f09b47a5ab6fb6d2f9e51d7fa15';
    const GOOGLE_FONTS_API_KEY = 'AIzaSyCfCq6uQdUk35EosgGc-aSEIK9sCq4BVFY';

    let currentMode = 'new';
    let selectedTemplateId = null;
    let existingTemplateData = null;
    let backgroundType = 'original'; // 'original' or 'color'
    
    // Google Fonts catalog (cached)
    let googleFontsCatalog = null;
    
    // Font mappings (fontFamily -> googleFontName)
    let fontMappings = {};
    
    // Fetched template layers (from Fetch Info)
    let fetchedLayers = null;

    // ============================================
    // Authentication
    // ============================================
    
    function checkAuth() {
      const isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
      if (isAuthenticated) {
        showMainContent();
      }
    }

    document.getElementById('authForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('passwordInput').value;
      
      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminAuth', 'true');
        showMainContent();
      } else {
        document.getElementById('authError').classList.remove('hidden');
        document.getElementById('passwordInput').value = '';
      }
    });

    function showMainContent() {
      document.getElementById('authOverlay').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    }

    // Mode toggle
    function setMode(mode) {
      currentMode = mode;
      const newBtn = document.getElementById('modeNewBtn');
      const existingBtn = document.getElementById('modeExistingBtn');
      const canvasSizeSection = document.getElementById('canvasSizeSection');
      const nameRequired = document.getElementById('nameRequired');
      const nameOptionalHint = document.getElementById('nameOptionalHint');
      const templatedIdHint = document.getElementById('templatedIdHint');
      const existingTemplateInfo = document.getElementById('existingTemplateInfo');
      const fastSyncSection = document.getElementById('fastSyncSection');
      const updateThumbnailNote = document.getElementById('updateThumbnailNote');
      const btnText = document.getElementById('btnText');
      
      if (mode === 'new') {
        newBtn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
        newBtn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        existingBtn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        existingBtn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        canvasSizeSection.classList.remove('hidden');
        nameRequired.classList.remove('hidden');
        nameOptionalHint.classList.add('hidden');
        templatedIdHint.textContent = 'From Templated.io URL or API';
        existingTemplateInfo.classList.add('hidden');
        fastSyncSection.classList.remove('hidden');
        updateThumbnailNote.classList.add('hidden');
        btnText.textContent = 'Sync & Generate';
        clearForm();
      } else {
        existingBtn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
        existingBtn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        newBtn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        newBtn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        canvasSizeSection.classList.add('hidden');
        nameRequired.classList.add('hidden');
        nameOptionalHint.classList.remove('hidden');
        templatedIdHint.textContent = 'Enter Templated.io ID to find and update an existing template';
        existingTemplateInfo.classList.add('hidden');
        fastSyncSection.classList.add('hidden');
        updateThumbnailNote.classList.remove('hidden');
        btnText.textContent = 'Update & Regenerate';
        clearForm();
        // Lookup existing template if templated_id already has a value
        const currentTemplatedId = document.getElementById('templated_id').value.trim();
        if (currentTemplatedId) {
          lookupTemplateByTemplatedId(currentTemplatedId);
        }
      }
    }

    // Clear form
    function clearForm() {
      document.getElementById('templated_id').value = '';
      document.getElementById('name').value = '';
      document.getElementById('name').placeholder = 'e.g., Story-BeforeAfter-Beige';
      document.getElementById('canvas_width').value = 1080;
      document.getElementById('canvas_height').value = 1350;
      document.getElementById('default_bg_color').value = '#FFFFFF';
      document.getElementById('default_bg_color_hex').value = '#FFFFFF';
      document.getElementById('default_theme_color').value = '#303030';
      document.getElementById('default_theme_color_hex').value = '#303030';
      document.getElementById('is_active').checked = true;
      selectedTemplateId = null;
      existingTemplateData = null;
      document.getElementById('fontStatus').classList.add('hidden');
      document.getElementById('existingTemplateInfo').classList.add('hidden');
      document.getElementById('fontsFoundSection').classList.add('hidden');
      document.getElementById('default_text_transform').value = 'none';
      fontMappings = {};
      fetchedLayers = null;
      updatePresetButtons();
      setBackgroundType('original'); // Default to original background
    }

    // Background type toggle
    function setBackgroundType(type) {
      backgroundType = type;
      const originalBtn = document.getElementById('bgTypeOriginal');
      const colorBtn = document.getElementById('bgTypeColor');
      const bgColorSection = document.getElementById('bgColorSection');
      
      if (type === 'original') {
        originalBtn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
        originalBtn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        colorBtn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        colorBtn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        bgColorSection.classList.add('hidden');
      } else {
        colorBtn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
        colorBtn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        originalBtn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        originalBtn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        bgColorSection.classList.remove('hidden');
      }
    }

    // Lookup template by Templated ID
    let lookupTimeout = null;
    async function lookupTemplateByTemplatedId(templatedId) {
      if (!templatedId || currentMode !== 'existing') return;
      
      const existingTemplateInfo = document.getElementById('existingTemplateInfo');
      const existingTemplateName = document.getElementById('existingTemplateName');
      const existingTemplateSize = document.getElementById('existingTemplateSize');
      
      try {
        const { data, error } = await supabaseClient
          .from('templates')
          .select('id, templated_id, name, canvas_width, canvas_height, default_background_color, default_theme_color, is_active, background_type, default_text_transform')
          .eq('templated_id', templatedId)
          .single();
        
        if (error || !data) {
          existingTemplateInfo.classList.add('hidden');
          selectedTemplateId = null;
          existingTemplateData = null;
          return;
        }
        
        // Found template - populate form
        selectedTemplateId = data.id;
        existingTemplateData = data;
        
        // Show template info
        existingTemplateName.textContent = data.name;
        existingTemplateSize.textContent = `${data.canvas_width}√ó${data.canvas_height}`;
        existingTemplateInfo.classList.remove('hidden');
        
        // Pre-fill form with existing values (user can optionally change them)
        document.getElementById('name').value = ''; // Leave blank so user can keep existing
        document.getElementById('name').placeholder = data.name; // Show current name as placeholder
        document.getElementById('canvas_width').value = data.canvas_width || 1080;
        document.getElementById('canvas_height').value = data.canvas_height || 1350;
        document.getElementById('default_bg_color').value = data.default_background_color || '#FFFFFF';
        document.getElementById('default_bg_color_hex').value = data.default_background_color || '#FFFFFF';
        document.getElementById('default_theme_color').value = data.default_theme_color || '#303030';
        document.getElementById('default_theme_color_hex').value = data.default_theme_color || '';
        document.getElementById('is_active').checked = data.is_active;
        
        // Set background type based on existing template
        // If no background_color is set or it's marked as 'original', use original
        const bgType = data.background_type || (data.default_background_color ? 'color' : 'original');
        setBackgroundType(bgType);
        
        // Set text transform
        document.getElementById('default_text_transform').value = data.default_text_transform || 'none';
        
      } catch (err) {
        console.error('Error looking up template:', err);
        existingTemplateInfo.classList.add('hidden');
        selectedTemplateId = null;
        existingTemplateData = null;
      }
    }

    // Handle templated_id input change (for update mode lookup)
    document.getElementById('templated_id').addEventListener('input', (e) => {
      if (currentMode !== 'existing') return;
      
      // Debounce lookup
      clearTimeout(lookupTimeout);
      lookupTimeout = setTimeout(() => {
        lookupTemplateByTemplatedId(e.target.value.trim());
      }, 500);
    });

    // Canvas size presets
    function setPreset(width, height, button) {
      document.getElementById('canvas_width').value = width;
      document.getElementById('canvas_height').value = height;
      updatePresetButtons();
    }

    function updatePresetButtons() {
      const width = parseInt(document.getElementById('canvas_width').value);
      const height = parseInt(document.getElementById('canvas_height').value);
      
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        btn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
      });
      
      // Find matching preset
      const presets = [[1080, 1350], [1080, 1080], [1080, 1920]];
      presets.forEach((preset, i) => {
        if (width === preset[0] && height === preset[1]) {
          const btn = document.querySelectorAll('.preset-btn')[i];
          btn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
          btn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        }
      });
    }

    // Sync color pickers with hex inputs
    document.getElementById('default_bg_color').addEventListener('input', e => {
      document.getElementById('default_bg_color_hex').value = e.target.value.toUpperCase();
    });
    document.getElementById('default_bg_color_hex').addEventListener('input', e => {
      const hex = e.target.value.trim();
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        document.getElementById('default_bg_color').value = hex;
      }
    });
    document.getElementById('default_theme_color').addEventListener('input', e => {
      document.getElementById('default_theme_color_hex').value = e.target.value.toUpperCase();
    });
    document.getElementById('default_theme_color_hex').addEventListener('input', e => {
      const hex = e.target.value.trim();
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        document.getElementById('default_theme_color').value = hex;
      }
    });

    // Status display
    function showStatus(message, isSuccess, details = null) {
      const el = document.getElementById('statusMessage');
      el.className = `mt-6 p-4 rounded-xl ${isSuccess ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`;
      el.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-xl">${isSuccess ? '‚úÖ' : '‚ùå'}</span>
          <div class="flex-1">
            <p class="font-medium">${isSuccess ? 'Success!' : 'Error'}</p>
            <p class="text-sm mt-1">${message}</p>
            ${details ? `<details class="mt-2"><summary class="text-xs cursor-pointer">Details</summary><pre class="mt-1 text-xs overflow-auto p-2 bg-black/10 rounded">${JSON.stringify(details, null, 2)}</pre></details>` : ''}
          </div>
        </div>
      `;
      el.classList.remove('hidden');
      el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Save font mappings to custom_fonts table
    async function saveFontMappings() {
      const mappingsToSave = Object.entries(fontMappings);
      if (mappingsToSave.length === 0) return { saved: 0, errors: [] };
      
      let saved = 0;
      const errors = [];
      
      for (const [fontFamily, googleFontName] of mappingsToSave) {
        try {
          // Check if font already exists
          const { data: existing } = await supabaseClient
            .from('custom_fonts')
            .select('id')
            .eq('name', fontFamily)
            .single();
          
          if (existing) {
            // Update existing font with Google Font name
            const { error: updateError } = await supabaseClient
              .from('custom_fonts')
              .update({
                google_font_name: googleFontName,
                source: 'google',
                is_active: true,
                updated_at: new Date().toISOString()
              })
              .eq('id', existing.id);
            
            if (updateError) throw updateError;
          } else {
            // Insert new font record
            const { error: insertError } = await supabaseClient
              .from('custom_fonts')
              .insert({
                name: fontFamily,
                google_font_name: googleFontName,
                source: 'google',
                is_active: true,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
              });
            
            if (insertError) throw insertError;
          }
          
          saved++;
          console.log(`Saved font mapping: "${fontFamily}" -> "${googleFontName}"`);
          
        } catch (err) {
          console.error(`Failed to save font ${fontFamily}:`, err);
          errors.push({ fontFamily, error: err.message });
        }
      }
      
      return { saved, errors };
    }

    // Font status display
    function showFontStatus(fontData) {
      const fontStatusEl = document.getElementById('fontStatus');
      const contentEl = document.getElementById('fontStatusContent');
      
      if (!fontData || fontData.total === 0) {
        fontStatusEl.classList.add('hidden');
        return;
      }
      
      fontStatusEl.classList.remove('hidden');
      
      let html = `<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Found ${fontData.total} font(s) in this template:</p>`;
      
      // Google fonts (ready to use)
      if (fontData.googleFonts && fontData.googleFonts.length > 0) {
        html += `
          <div class="mb-3">
            <p class="text-xs font-medium text-green-600 mb-1">‚úÖ Google Fonts (Ready)</p>
            <div class="flex flex-wrap gap-1">
              ${fontData.googleFonts.map(f => `<span class="text-xs px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">${escapeHtml(f)}</span>`).join('')}
            </div>
          </div>
        `;
      }
      
      // Custom fonts needing upload
      if (fontData.customFontsNeedingUpload && fontData.customFontsNeedingUpload.length > 0) {
        html += `
          <div class="mb-3">
            <p class="text-xs font-medium text-amber-600 mb-1">‚ö†Ô∏è Custom Fonts (Need Upload)</p>
            <div class="flex flex-wrap gap-1">
              ${fontData.customFontsNeedingUpload.map(f => `<span class="text-xs px-2 py-1 rounded bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">${escapeHtml(f)}</span>`).join('')}
            </div>
            <a href="fonts.html" class="inline-block mt-2 text-xs text-primary hover:underline">‚Üí Go to Font Management to upload</a>
          </div>
        `;
      }
      
      contentEl.innerHTML = html;
    }

    // Loading state
    function setLoading(isLoading, stage = 'Processing...') {
      const btn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      btn.disabled = isLoading;
      btnText.textContent = isLoading ? stage : (currentMode === 'new' ? 'Sync & Generate' : 'Update & Regenerate');
      btnSpinner.classList.toggle('hidden', !isLoading);
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Form submission
    document.getElementById('mainForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('statusMessage').classList.add('hidden');
      document.getElementById('fontStatus').classList.add('hidden');
      
      const templatedId = document.getElementById('templated_id').value.trim();
      const nameInput = document.getElementById('name').value.trim();
      const canvasWidth = parseInt(document.getElementById('canvas_width').value);
      const canvasHeight = parseInt(document.getElementById('canvas_height').value);
      const isActive = document.getElementById('is_active').checked;
      
      // Get colors based on background type
      const bgColorHex = document.getElementById('default_bg_color_hex').value.trim();
      const themeColorHex = document.getElementById('default_theme_color_hex').value.trim();
      // Only use background color if type is 'color', otherwise null for original/image backgrounds
      const defaultBgColor = backgroundType === 'color' 
        ? (/^#[0-9A-Fa-f]{6}$/.test(bgColorHex) ? bgColorHex.toUpperCase() : '#FFFFFF')
        : null;
      const defaultThemeColor = /^#[0-9A-Fa-f]{6}$/.test(themeColorHex) ? themeColorHex.toUpperCase() : null;
      
      // Validate based on mode
      if (!templatedId) {
        showStatus('Please enter a Templated ID', false);
        return;
      }
      
      if (currentMode === 'new' && !nameInput) {
        showStatus('Please enter a template name', false);
        return;
      }
      
      if (currentMode === 'existing' && !selectedTemplateId) {
        showStatus('Template not found. Please enter a valid Templated ID that exists in the database.', false);
        return;
      }
      
      setLoading(true, 'Syncing template...');
      
      try {
        let templateId = selectedTemplateId;
        // For update mode: use existing name if not provided
        const name = currentMode === 'existing' && !nameInput && existingTemplateData 
          ? existingTemplateData.name 
          : nameInput;
        
        const defaultTextTransform = document.getElementById('default_text_transform').value;
        
        if (currentMode === 'new') {
          // New template: call webhook to sync
          const syncResponse = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              templated_id: templatedId,
              name: name,
              canvas_width: canvasWidth,
              canvas_height: canvasHeight,
              is_active: isActive,
              supports: ['single'],
              background_type: backgroundType,
              default_background_color: defaultBgColor,
              default_theme_color: defaultThemeColor,
              default_text_transform: defaultTextTransform
            })
          });
          
          const syncResult = await syncResponse.json();
          
          if (!syncResponse.ok || !syncResult.success) {
            throw new Error(syncResult.error || syncResult.message || 'Sync failed');
          }
          
          templateId = syncResult.template_id || syncResult.templateId;
          
          // If we don't have templateId from sync, fetch it
          if (!templateId) {
            const { data } = await supabaseClient
              .from('templates')
              .select('id')
              .eq('templated_id', templatedId)
              .single();
            templateId = data?.id;
          }
        } else {
          // Existing template: update in database (do NOT update canvas size)
          setLoading(true, 'Updating database...');
          
          // Build update object - exclude canvas size for resyncing
          const updateData = {
            is_active: isActive,
            background_type: backgroundType,
            default_background_color: defaultBgColor,
            default_theme_color: defaultThemeColor,
            default_text_transform: defaultTextTransform,
            updated_at: new Date().toISOString()
          };
          
          // Only update name if a new one was provided
          if (nameInput) {
            updateData.name = nameInput;
          }
          
          const { error: updateError } = await supabaseClient
            .from('templates')
            .update(updateData)
            .eq('id', templateId);
          
          if (updateError) throw updateError;
        }
        
        // Generate frame overlay (extracts theme layers + opacity + FONTS)
        if (templateId) {
          const skipThumbnail = document.getElementById('skip_thumbnail').checked;
          
          // Save font mappings BEFORE generating frame overlay
          if (Object.keys(fontMappings).length > 0) {
            setLoading(true, 'Saving font mappings...');
            const fontSaveResult = await saveFontMappings();
            console.log('Font mappings saved:', fontSaveResult);
          }
          
          setLoading(true, 'Generating frame overlay...');
          const overlayResponse = await fetch(FRAME_OVERLAY_FUNCTION_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({ template_id: templateId })
          });
          
          const overlayResult = await overlayResponse.json();
          
          if (!overlayResponse.ok || !overlayResult.success) {
            // Show partial success
            showStatus(`Template saved but frame overlay generation failed: ${overlayResult.error || 'Unknown error'}. You can retry later.`, false, overlayResult);
            setLoading(false);
            return;
          }
          
          // Show font status from overlay result
          if (overlayResult.fonts) {
            showFontStatus(overlayResult.fonts);
          }
          
          let thumbnailMsg = '';
          let thumbnailResult = null;
          
          // For updates: always regenerate thumbnail
          // For new templates: respect the fast sync setting
          const shouldGenerateThumbnail = currentMode === 'existing' || !skipThumbnail;
          
          if (shouldGenerateThumbnail) {
            setLoading(true, 'Generating thumbnail...');
            const thumbnailResponse = await fetch(THUMBNAIL_FUNCTION_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              },
              body: JSON.stringify({ template_id: templateId })
            });
            
            thumbnailResult = await thumbnailResponse.json();
            
            if (!thumbnailResponse.ok || !thumbnailResult.success) {
              thumbnailMsg = ` Thumbnail generation failed: ${thumbnailResult.error || 'Unknown error'}.`;
            } else {
              thumbnailMsg = ' Thumbnail updated.';
            }
          } else {
            thumbnailMsg = ' Using Templated.io preview (fast sync).';
          }
          
          // Success message with details
          const themeCount = overlayResult.stats?.themeLayers || 0;
          const fontCount = overlayResult.fonts?.total || 0;
          let msg = `Template "${name}" saved successfully!`;
          if (themeCount > 0) {
            msg += ` ${themeCount} theme layer(s) detected.`;
          }
          if (fontCount > 0) {
            msg += ` ${fontCount} font(s) registered.`;
          }
          
          // Show background color info
          const bgInfo = overlayResult.backgroundColor;
          if (bgInfo) {
            if (bgInfo.wasAutoFetched) {
              msg += ` üé® BG auto-fetched from Templated.io: ${bgInfo.value}`;
              // Update the form to show the fetched color
              document.getElementById('default_bg_color').value = bgInfo.value;
              document.getElementById('default_bg_color_hex').value = bgInfo.value;
            } else {
              msg += ` BG: ${bgInfo.value} (manual)`;
            }
          } else {
            msg += ` Default BG: ${defaultBgColor}`;
          }
          
          if (defaultThemeColor) {
            msg += `, Theme: ${defaultThemeColor}`;
          }
          msg += '.';
          msg += thumbnailMsg;
          
          showStatus(msg, true, { overlay: overlayResult, thumbnail: thumbnailResult });
          
          // Clear form for new template mode
          if (currentMode === 'new') {
            document.getElementById('templated_id').value = '';
            document.getElementById('name').value = '';
          }
          
          // Clear update mode state
          if (currentMode === 'existing') {
            document.getElementById('templated_id').value = '';
            document.getElementById('existingTemplateInfo').classList.add('hidden');
            selectedTemplateId = null;
            existingTemplateData = null;
          }
          
        } else {
          showStatus('Template synced but could not generate overlay (missing template ID). Please try again.', false);
        }
        
      } catch (error) {
        console.error('Error:', error);
        showStatus(error.message || 'An error occurred', false);
      } finally {
        setLoading(false);
      }
    });

    // Batch thumbnail regeneration
    async function regenerateAllThumbnails() {
      const btn = document.getElementById('batchBtn');
      const btnText = document.getElementById('batchBtnText');
      const spinner = document.getElementById('batchSpinner');
      const status = document.getElementById('batchStatus');
      
      btn.disabled = true;
      btnText.textContent = 'Regenerating...';
      spinner.classList.remove('hidden');
      status.classList.add('hidden');
      
      try {
        const response = await fetch(THUMBNAIL_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ generate_all: true })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Batch regeneration failed');
        }
        
        // Show results
        const successCount = result.successCount || 0;
        const failCount = result.failCount || 0;
        const total = result.totalProcessed || 0;
        
        status.className = 'mt-3 text-sm p-3 rounded-lg ' + (failCount === 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300');
        status.innerHTML = `
          <p class="font-medium">‚úÖ Batch complete!</p>
          <p>Processed: ${total} templates</p>
          <p>Success: ${successCount} | Failed: ${failCount}</p>
          ${result.results ? `<details class="mt-2"><summary class="cursor-pointer text-xs">View details</summary><pre class="mt-1 text-xs overflow-auto p-2 bg-black/10 rounded max-h-40">${JSON.stringify(result.results, null, 2)}</pre></details>` : ''}
        `;
        status.classList.remove('hidden');
        
      } catch (error) {
        console.error('Batch regeneration error:', error);
        status.className = 'mt-3 text-sm p-3 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
        status.innerHTML = `<p class="font-medium">‚ùå Error</p><p>${error.message}</p>`;
        status.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Regenerate All Thumbnails';
        spinner.classList.add('hidden');
      }
    }

    // ============================================
    // Google Fonts & Template Info
    // ============================================
    
    async function fetchGoogleFontsCatalog() {
      if (googleFontsCatalog) return googleFontsCatalog;
      
      try {
        const response = await fetch(`https://www.googleapis.com/webfonts/v1/webfonts?sort=popularity&key=${GOOGLE_FONTS_API_KEY}`);
        const data = await response.json();
        googleFontsCatalog = data.items || [];
        console.log(`Loaded ${googleFontsCatalog.length} Google Fonts`);
        return googleFontsCatalog;
      } catch (err) {
        console.error('Failed to fetch Google Fonts:', err);
        return [];
      }
    }
    
    function searchGoogleFonts(query) {
      if (!googleFontsCatalog || !query.trim()) return [];
      
      const lowerQuery = query.toLowerCase();
      return googleFontsCatalog
        .filter(font => font.family.toLowerCase().includes(lowerQuery))
        .slice(0, 8);
    }
    
    async function fetchTemplateInfo() {
      const templatedId = document.getElementById('templated_id').value.trim();
      if (!templatedId) {
        alert('Please enter a Templated ID first');
        return;
      }
      
      const btn = document.getElementById('fetchInfoBtn');
      const spinner = document.getElementById('fetchInfoSpinner');
      const text = document.getElementById('fetchInfoText');
      
      btn.disabled = true;
      spinner.classList.remove('hidden');
      text.textContent = 'Fetching...';
      
      try {
        // Ensure Google Fonts catalog is loaded
        await fetchGoogleFontsCatalog();
        
        // Fetch template layers from Templated.io
        const layersUrl = `https://api.templated.io/v1/template/${templatedId}/layers?includeLockedLayers=true`;
        const response = await fetch(layersUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${TEMPLATED_API_KEY}`,
            'Content-Type': 'application/json',
          },
        });
        
        if (!response.ok) {
          throw new Error(`Failed to fetch template: ${response.status}`);
        }
        
        const layersData = await response.json();
        fetchedLayers = Array.isArray(layersData) ? layersData : layersData.layers || [];
        
        console.log(`Fetched ${fetchedLayers.length} layers from Templated.io`);
        
        // Extract fonts
        const fonts = extractFontsFromLayers(fetchedLayers);
        
        // Display fonts
        displayFontsFound(fonts);
        
      } catch (err) {
        console.error('Error fetching template info:', err);
        alert(`Error: ${err.message}`);
      } finally {
        btn.disabled = false;
        spinner.classList.add('hidden');
        text.textContent = 'Fetch Info';
      }
    }
    
    function extractFontsFromLayers(layers) {
      const systemFonts = new Set(['system', 'san francisco', 'helvetica', 'helvetica neue', 'arial', 'roboto', 'sans-serif', 'serif', 'monospace']);
      const fontSet = new Set();
      
      layers.forEach(layer => {
        if (layer.font_family && layer.font_family.trim()) {
          const fontName = layer.font_family.trim();
          if (!systemFonts.has(fontName.toLowerCase())) {
            fontSet.add(fontName);
          }
        }
      });
      
      return Array.from(fontSet);
    }
    
    function displayFontsFound(fonts) {
      const section = document.getElementById('fontsFoundSection');
      const countEl = document.getElementById('fontsFoundCount');
      const listEl = document.getElementById('fontsFoundList');
      
      if (fonts.length === 0) {
        section.classList.add('hidden');
        return;
      }
      
      section.classList.remove('hidden');
      countEl.textContent = `${fonts.length} font${fonts.length > 1 ? 's' : ''}`;
      
      // Reset font mappings
      fontMappings = {};
      
      listEl.innerHTML = fonts.map((font, index) => `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between mb-2">
            <p class="font-medium text-gray-900 dark:text-white text-sm">${escapeHtml(font)}</p>
            <span id="fontStatus_${index}" class="text-xs px-2 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">Not linked</span>
          </div>
          <div class="autocomplete-container">
            <input 
              type="text" 
              id="fontSearch_${index}"
              data-font-family="${escapeHtml(font)}"
              data-font-index="${index}"
              placeholder="Search Google Fonts..."
              class="w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400"
              autocomplete="off"
              oninput="handleFontSearch(event, ${index})"
              onfocus="handleFontSearch(event, ${index})"
            >
            <div id="fontDropdown_${index}" class="autocomplete-dropdown hidden"></div>
          </div>
          <div id="fontSelected_${index}" class="hidden mt-2 flex items-center justify-between p-2 rounded bg-green-100 dark:bg-green-800/30">
            <span class="text-sm text-green-800 dark:text-green-200">
              <span class="font-medium">Linked:</span> <span id="fontSelectedName_${index}"></span>
            </span>
            <button onclick="clearFontSelection(${index}, '${escapeHtml(font)}')" class="text-green-600 dark:text-green-400 hover:text-green-800 text-sm">‚úï</button>
          </div>
        </div>
      `).join('');
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', closeAllFontDropdowns);
    }
    
    function handleFontSearch(event, index) {
      const query = event.target.value;
      const dropdown = document.getElementById(`fontDropdown_${index}`);
      
      if (query.length < 2) {
        dropdown.classList.add('hidden');
        return;
      }
      
      const results = searchGoogleFonts(query);
      
      if (results.length === 0) {
        dropdown.innerHTML = '<div class="p-3 text-sm text-gray-500">No matching fonts found</div>';
        dropdown.classList.remove('hidden');
        return;
      }
      
      const fontFamily = event.target.dataset.fontFamily;
      
      dropdown.innerHTML = results.map(font => `
        <div class="autocomplete-item" onclick="selectGoogleFont(${index}, '${escapeHtml(fontFamily)}', '${escapeHtml(font.family)}')">
          <span class="text-green-600">üî§</span>
          <div>
            <p class="text-gray-900 dark:text-white">${escapeHtml(font.family)}</p>
            <p class="text-xs text-gray-500">${font.variants.length} variant(s)</p>
          </div>
        </div>
      `).join('');
      
      dropdown.classList.remove('hidden');
    }
    
    function selectGoogleFont(index, fontFamily, googleFontName) {
      // Store mapping
      fontMappings[fontFamily] = googleFontName;
      
      // Update UI
      document.getElementById(`fontSearch_${index}`).value = googleFontName;
      document.getElementById(`fontDropdown_${index}`).classList.add('hidden');
      document.getElementById(`fontSelected_${index}`).classList.remove('hidden');
      document.getElementById(`fontSelectedName_${index}`).textContent = googleFontName;
      
      // Update status badge
      const statusEl = document.getElementById(`fontStatus_${index}`);
      statusEl.textContent = 'Linked';
      statusEl.className = 'text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300';
      
      console.log(`Font mapped: "${fontFamily}" -> "${googleFontName}"`);
    }
    
    function clearFontSelection(index, fontFamily) {
      // Remove mapping
      delete fontMappings[fontFamily];
      
      // Update UI
      document.getElementById(`fontSearch_${index}`).value = '';
      document.getElementById(`fontSelected_${index}`).classList.add('hidden');
      
      // Update status badge
      const statusEl = document.getElementById(`fontStatus_${index}`);
      statusEl.textContent = 'Not linked';
      statusEl.className = 'text-xs px-2 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300';
    }
    
    function closeAllFontDropdowns(event) {
      if (!event.target.closest('.autocomplete-container')) {
        document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
          dropdown.classList.add('hidden');
        });
      }
    }
    
    // Prefetch Google Fonts catalog on page load
    fetchGoogleFontsCatalog();

    // Dark mode detection
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }

    // Check auth on load
    checkAuth();
  </script>
</body>
</html>
