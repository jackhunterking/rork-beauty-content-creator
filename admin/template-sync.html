<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resulta Admin - Template Sync</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#E91E63',
          }
        }
      }
    }
  </script>
  <style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
  
  <!-- Password Protection Overlay -->
  <div id="authOverlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">üîê Admin Access</h2>
      <form id="authForm">
        <input 
          type="password" 
          id="passwordInput"
          placeholder="Enter password"
          class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary transition mb-4"
          autofocus
        >
        <button 
          type="submit"
          class="w-full py-3 px-6 rounded-lg bg-primary hover:bg-pink-600 text-white font-semibold transition"
        >
          Access Admin
        </button>
        <p id="authError" class="hidden mt-3 text-red-500 text-sm text-center">Incorrect password</p>
      </form>
    </div>
  </div>

  <!-- Main Content (hidden until authenticated) -->
  <div id="mainContent" class="hidden">
    <div class="max-w-xl mx-auto p-6">
      
      <!-- Header with Navigation -->
      <div class="mb-6 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Template Sync</h1>
          <p class="text-sm text-gray-500 dark:text-gray-400">Add or update templates from Templated.io</p>
        </div>
        <a href="fonts.html" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium transition">
          üî§ Manage Fonts
        </a>
      </div>

      <!-- Mode Toggle -->
      <div class="flex gap-2 mb-6">
        <button 
          onclick="setMode('new')" 
          id="modeNewBtn"
          class="flex-1 py-3 px-4 rounded-lg font-medium transition-all border-2 border-primary bg-primary/10 text-primary"
        >
          + New Template
        </button>
        <button 
          onclick="setMode('existing')" 
          id="modeExistingBtn"
          class="flex-1 py-3 px-4 rounded-lg font-medium transition-all border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400"
        >
          Update Existing
        </button>
      </div>

      <!-- Main Form -->
      <form id="mainForm" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 space-y-5">
        
        <!-- Existing Template Selector (hidden by default) -->
        <div id="existingTemplateSection" class="hidden">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Select Template
          </label>
          <select 
            id="existing_template" 
            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition"
          >
            <option value="">Loading...</option>
          </select>
        </div>

        <!-- Templated ID -->
        <div id="templatedIdSection">
          <label for="templated_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Templated ID <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="templated_id" 
            required
            placeholder="e.g., e56ddb13-f39d-4b4b-a2aa-1586c5e17273"
            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary transition"
          >
          <p class="mt-1 text-xs text-gray-500">From Templated.io URL or API</p>
        </div>

        <!-- Template Name -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Template Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="name" 
            required
            placeholder="e.g., Story-BeforeAfter-Beige"
            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary transition"
          >
        </div>

        <!-- Canvas Size -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Canvas Size <span class="text-red-500">*</span>
          </label>
          <div class="grid grid-cols-3 gap-2 mb-2">
            <button type="button" onclick="setPreset(1080, 1350, this)" class="preset-btn py-2 rounded-lg border-2 border-primary bg-primary/10 text-primary font-medium text-sm">
              4:5 <span class="text-xs opacity-75 block">1080√ó1350</span>
            </button>
            <button type="button" onclick="setPreset(1080, 1080, this)" class="preset-btn py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-medium text-sm">
              1:1 <span class="text-xs opacity-75 block">1080√ó1080</span>
            </button>
            <button type="button" onclick="setPreset(1080, 1920, this)" class="preset-btn py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-medium text-sm">
              9:16 <span class="text-xs opacity-75 block">1080√ó1920</span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input type="number" id="canvas_width" value="1080" min="100" max="4096" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
            <input type="number" id="canvas_height" value="1350" min="100" max="4096" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
          </div>
        </div>

        <!-- Default Colors Section -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-5">
          <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">üé® Default Colors</p>
          
          <!-- Background Color -->
          <div class="flex items-center gap-3 mb-3">
            <input type="color" id="default_bg_color" value="#FFFFFF" class="w-10 h-10 rounded border-2 border-gray-300 cursor-pointer">
            <div class="flex-1">
              <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Background Color</label>
              <input type="text" id="default_bg_color_hex" value="#FFFFFF" placeholder="#FFFFFF" class="w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm font-mono">
            </div>
          </div>
          
          <!-- Theme Color -->
          <div class="flex items-center gap-3">
            <input type="color" id="default_theme_color" value="#303030" class="w-10 h-10 rounded border-2 border-purple-300 cursor-pointer">
            <div class="flex-1">
              <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Theme Color <span class="text-purple-500">(for theme-* layers)</span></label>
              <input type="text" id="default_theme_color_hex" value="#303030" placeholder="#303030 or leave empty" class="w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm font-mono">
            </div>
          </div>
          
          <p class="text-xs text-gray-500 mt-2">These colors show when user first opens the template. They can change them in the app.</p>
        </div>

        <!-- Active Toggle -->
        <div class="flex items-center gap-2">
          <input type="checkbox" id="is_active" checked class="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
          <label for="is_active" class="text-sm text-gray-700 dark:text-gray-300">Active (visible in app)</label>
        </div>

        <!-- Skip Thumbnail Toggle (faster sync) -->
        <div class="flex items-center gap-2 border-t border-gray-200 dark:border-gray-700 pt-4">
          <input type="checkbox" id="skip_thumbnail" checked class="w-5 h-5 rounded border-gray-300 text-purple-500 focus:ring-purple-500">
          <label for="skip_thumbnail" class="text-sm text-gray-700 dark:text-gray-300">
            <span class="font-medium">Fast sync</span> 
            <span class="text-xs text-gray-500">(use Templated.io preview, skip thumbnail generation)</span>
          </label>
        </div>

        <!-- Submit Button -->
        <button 
          type="submit" 
          id="submitBtn"
          class="w-full py-4 px-6 rounded-xl bg-primary hover:bg-pink-600 text-white font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2"
        >
          <span id="btnText">Sync & Generate</span>
          <svg id="btnSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>

      <!-- Status Message -->
      <div id="statusMessage" class="hidden mt-6"></div>

      <!-- Font Status (shown after sync) -->
      <div id="fontStatus" class="hidden mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-3">üî§ Font Status</p>
        <div id="fontStatusContent"></div>
      </div>

      <!-- Batch Thumbnail Regeneration -->
      <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-3">üñºÔ∏è Batch Thumbnail Regeneration</p>
        <p class="text-xs text-gray-500 mb-3">Regenerate thumbnails for all templates with their default background and theme colors.</p>
        <button 
          type="button" 
          onclick="regenerateAllThumbnails()"
          id="batchBtn"
          class="w-full py-3 px-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-medium transition-all flex items-center justify-center gap-2"
        >
          <span id="batchBtnText">Regenerate All Thumbnails</span>
          <svg id="batchSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
        <div id="batchStatus" class="hidden mt-3 text-sm"></div>
      </div>

      <!-- Layer Naming Quick Reference (Collapsed) -->
      <details class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <summary class="font-medium text-gray-700 dark:text-gray-300 cursor-pointer">üìã Layer Naming Convention (STRICT)</summary>
        <div class="mt-3 text-xs space-y-2 text-gray-600 dark:text-gray-400">
          <p><code class="bg-green-100 dark:bg-green-900 px-1 rounded">slot-*</code> ‚Üí Photo placeholders (hidden in PNG, app renders user photos)</p>
          <p><code class="bg-purple-100 dark:bg-purple-900 px-1 rounded">theme-*</code> ‚Üí Color-changeable layers (hidden in PNG, app renders with theme color)</p>
          <p><code class="bg-blue-100 dark:bg-blue-900 px-1 rounded">vector</code> type ‚Üí SVG icons/shapes (hidden in PNG, app renders as SVG)</p>
          <p><strong>Everything else</strong> ‚Üí Static content (stays in frame overlay PNG as-is)</p>
          <hr class="my-2 border-gray-300 dark:border-gray-600">
          <p class="font-medium">‚ö†Ô∏è STRICT PREFIX MATCHING:</p>
          <p>‚Ä¢ Use <code>slot-</code> prefix (not just "slot" anywhere in name)</p>
          <p>‚Ä¢ Use <code>theme-</code> prefix (not just "theme" anywhere in name)</p>
          <p>‚Ä¢ No hardcoded background layer names - background transparency via API option</p>
        </div>
      </details>

    </div>
  </div>

  <script>
    // Configuration
    const ADMIN_PASSWORD = 'adminpanel123';
    const WEBHOOK_URL = 'https://jackhunterking.app.n8n.cloud/webhook/sync-template';
    const SUPABASE_URL = 'https://tmgjsrxdjbazrwvbdoed.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtZ2pzcnhkamJhenJ3dmJkb2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDE3MDcsImV4cCI6MjA4MzMxNzcwN30.krSbo9fqvKkbQrjFDnQo2s7JiaXwo1wydhvaontxtFE';
    const FRAME_OVERLAY_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/generate-frame-overlay`;
    const THUMBNAIL_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/generate-thumbnail`;

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentMode = 'new';
    let selectedTemplateId = null;

    // ============================================
    // Authentication
    // ============================================
    
    function checkAuth() {
      const isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
      if (isAuthenticated) {
        showMainContent();
      }
    }

    document.getElementById('authForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('passwordInput').value;
      
      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminAuth', 'true');
        showMainContent();
      } else {
        document.getElementById('authError').classList.remove('hidden');
        document.getElementById('passwordInput').value = '';
      }
    });

    function showMainContent() {
      document.getElementById('authOverlay').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      loadExistingTemplates();
    }

    // Mode toggle
    function setMode(mode) {
      currentMode = mode;
      const newBtn = document.getElementById('modeNewBtn');
      const existingBtn = document.getElementById('modeExistingBtn');
      const existingSection = document.getElementById('existingTemplateSection');
      const templatedIdSection = document.getElementById('templatedIdSection');
      const btnText = document.getElementById('btnText');
      
      if (mode === 'new') {
        newBtn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
        newBtn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        existingBtn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        existingBtn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        existingSection.classList.add('hidden');
        templatedIdSection.classList.remove('hidden');
        btnText.textContent = 'Sync & Generate';
        clearForm();
      } else {
        existingBtn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
        existingBtn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        newBtn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        newBtn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        existingSection.classList.remove('hidden');
        templatedIdSection.classList.add('hidden');
        btnText.textContent = 'Update & Regenerate';
        loadExistingTemplates();
      }
    }

    // Clear form
    function clearForm() {
      document.getElementById('templated_id').value = '';
      document.getElementById('name').value = '';
      document.getElementById('default_bg_color').value = '#FFFFFF';
      document.getElementById('default_bg_color_hex').value = '#FFFFFF';
      document.getElementById('default_theme_color').value = '#303030';
      document.getElementById('default_theme_color_hex').value = '#303030';
      selectedTemplateId = null;
      document.getElementById('fontStatus').classList.add('hidden');
    }

    // Load existing templates
    async function loadExistingTemplates() {
      const select = document.getElementById('existing_template');
      try {
        const { data, error } = await supabaseClient
          .from('templates')
          .select('id, templated_id, name, canvas_width, canvas_height, default_background_color, default_theme_color, is_active')
          .order('name', { ascending: true });
        
        if (error) throw error;
        
        select.innerHTML = '<option value="">-- Select a template --</option>' + 
          data.map(t => `<option value="${t.id}" data-templated-id="${t.templated_id}" data-name="${escapeHtml(t.name)}" data-width="${t.canvas_width}" data-height="${t.canvas_height}" data-bg="${t.default_background_color || '#FFFFFF'}" data-theme="${t.default_theme_color || ''}" data-active="${t.is_active}">${escapeHtml(t.name)}</option>`).join('');
      } catch (err) {
        console.error('Error loading templates:', err);
        select.innerHTML = '<option value="">Error loading</option>';
      }
    }

    // Handle existing template selection
    document.getElementById('existing_template').addEventListener('change', (e) => {
      const option = e.target.options[e.target.selectedIndex];
      if (!option.value) {
        clearForm();
        return;
      }
      
      selectedTemplateId = option.value;
      document.getElementById('templated_id').value = option.dataset.templatedId || '';
      document.getElementById('name').value = option.dataset.name || '';
      document.getElementById('canvas_width').value = option.dataset.width || 1080;
      document.getElementById('canvas_height').value = option.dataset.height || 1350;
      document.getElementById('default_bg_color').value = option.dataset.bg || '#FFFFFF';
      document.getElementById('default_bg_color_hex').value = option.dataset.bg || '#FFFFFF';
      document.getElementById('default_theme_color').value = option.dataset.theme || '#303030';
      document.getElementById('default_theme_color_hex').value = option.dataset.theme || '';
      document.getElementById('is_active').checked = option.dataset.active === 'true';
      
      // Update preset button states
      updatePresetButtons();
    });

    // Canvas size presets
    function setPreset(width, height, button) {
      document.getElementById('canvas_width').value = width;
      document.getElementById('canvas_height').value = height;
      updatePresetButtons();
    }

    function updatePresetButtons() {
      const width = parseInt(document.getElementById('canvas_width').value);
      const height = parseInt(document.getElementById('canvas_height').value);
      
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
        btn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
      });
      
      // Find matching preset
      const presets = [[1080, 1350], [1080, 1080], [1080, 1920]];
      presets.forEach((preset, i) => {
        if (width === preset[0] && height === preset[1]) {
          const btn = document.querySelectorAll('.preset-btn')[i];
          btn.classList.add('border-primary', 'bg-primary/10', 'text-primary');
          btn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-600', 'dark:text-gray-400');
        }
      });
    }

    // Sync color pickers with hex inputs
    document.getElementById('default_bg_color').addEventListener('input', e => {
      document.getElementById('default_bg_color_hex').value = e.target.value.toUpperCase();
    });
    document.getElementById('default_bg_color_hex').addEventListener('input', e => {
      const hex = e.target.value.trim();
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        document.getElementById('default_bg_color').value = hex;
      }
    });
    document.getElementById('default_theme_color').addEventListener('input', e => {
      document.getElementById('default_theme_color_hex').value = e.target.value.toUpperCase();
    });
    document.getElementById('default_theme_color_hex').addEventListener('input', e => {
      const hex = e.target.value.trim();
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        document.getElementById('default_theme_color').value = hex;
      }
    });

    // Status display
    function showStatus(message, isSuccess, details = null) {
      const el = document.getElementById('statusMessage');
      el.className = `mt-6 p-4 rounded-xl ${isSuccess ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`;
      el.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-xl">${isSuccess ? '‚úÖ' : '‚ùå'}</span>
          <div class="flex-1">
            <p class="font-medium">${isSuccess ? 'Success!' : 'Error'}</p>
            <p class="text-sm mt-1">${message}</p>
            ${details ? `<details class="mt-2"><summary class="text-xs cursor-pointer">Details</summary><pre class="mt-1 text-xs overflow-auto p-2 bg-black/10 rounded">${JSON.stringify(details, null, 2)}</pre></details>` : ''}
          </div>
        </div>
      `;
      el.classList.remove('hidden');
      el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Font status display
    function showFontStatus(fontData) {
      const fontStatusEl = document.getElementById('fontStatus');
      const contentEl = document.getElementById('fontStatusContent');
      
      if (!fontData || fontData.total === 0) {
        fontStatusEl.classList.add('hidden');
        return;
      }
      
      fontStatusEl.classList.remove('hidden');
      
      let html = `<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Found ${fontData.total} font(s) in this template:</p>`;
      
      // Google fonts (ready to use)
      if (fontData.googleFonts && fontData.googleFonts.length > 0) {
        html += `
          <div class="mb-3">
            <p class="text-xs font-medium text-green-600 mb-1">‚úÖ Google Fonts (Ready)</p>
            <div class="flex flex-wrap gap-1">
              ${fontData.googleFonts.map(f => `<span class="text-xs px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">${escapeHtml(f)}</span>`).join('')}
            </div>
          </div>
        `;
      }
      
      // Custom fonts needing upload
      if (fontData.customFontsNeedingUpload && fontData.customFontsNeedingUpload.length > 0) {
        html += `
          <div class="mb-3">
            <p class="text-xs font-medium text-amber-600 mb-1">‚ö†Ô∏è Custom Fonts (Need Upload)</p>
            <div class="flex flex-wrap gap-1">
              ${fontData.customFontsNeedingUpload.map(f => `<span class="text-xs px-2 py-1 rounded bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">${escapeHtml(f)}</span>`).join('')}
            </div>
            <a href="fonts.html" class="inline-block mt-2 text-xs text-primary hover:underline">‚Üí Go to Font Management to upload</a>
          </div>
        `;
      }
      
      contentEl.innerHTML = html;
    }

    // Loading state
    function setLoading(isLoading, stage = 'Processing...') {
      const btn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      btn.disabled = isLoading;
      btnText.textContent = isLoading ? stage : (currentMode === 'new' ? 'Sync & Generate' : 'Update & Regenerate');
      btnSpinner.classList.toggle('hidden', !isLoading);
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Form submission
    document.getElementById('mainForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('statusMessage').classList.add('hidden');
      document.getElementById('fontStatus').classList.add('hidden');
      
      const templatedId = document.getElementById('templated_id').value.trim();
      const name = document.getElementById('name').value.trim();
      const canvasWidth = parseInt(document.getElementById('canvas_width').value);
      const canvasHeight = parseInt(document.getElementById('canvas_height').value);
      const isActive = document.getElementById('is_active').checked;
      
      // Get colors
      const bgColorHex = document.getElementById('default_bg_color_hex').value.trim();
      const themeColorHex = document.getElementById('default_theme_color_hex').value.trim();
      const defaultBgColor = /^#[0-9A-Fa-f]{6}$/.test(bgColorHex) ? bgColorHex.toUpperCase() : '#FFFFFF';
      const defaultThemeColor = /^#[0-9A-Fa-f]{6}$/.test(themeColorHex) ? themeColorHex.toUpperCase() : null;
      
      if (!name) {
        showStatus('Please enter a template name', false);
        return;
      }
      
      setLoading(true, 'Syncing template...');
      
      try {
        let templateId = selectedTemplateId;
        
        if (currentMode === 'new') {
          // New template: call webhook to sync
          if (!templatedId) {
            showStatus('Please enter a Templated ID', false);
            setLoading(false);
            return;
          }
          
          const syncResponse = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              templated_id: templatedId,
              name: name,
              canvas_width: canvasWidth,
              canvas_height: canvasHeight,
              is_active: isActive,
              supports: ['single'],
              default_background_color: defaultBgColor,
              default_theme_color: defaultThemeColor
            })
          });
          
          const syncResult = await syncResponse.json();
          
          if (!syncResponse.ok || !syncResult.success) {
            throw new Error(syncResult.error || syncResult.message || 'Sync failed');
          }
          
          templateId = syncResult.template_id || syncResult.templateId;
          
          // If we don't have templateId from sync, fetch it
          if (!templateId) {
            const { data } = await supabaseClient
              .from('templates')
              .select('id')
              .eq('templated_id', templatedId)
              .single();
            templateId = data?.id;
          }
        } else {
          // Existing template: update in database
          setLoading(true, 'Updating database...');
          const { error: updateError } = await supabaseClient
            .from('templates')
            .update({
              name: name,
              canvas_width: canvasWidth,
              canvas_height: canvasHeight,
              is_active: isActive,
              default_background_color: defaultBgColor,
              default_theme_color: defaultThemeColor,
              updated_at: new Date().toISOString()
            })
            .eq('id', templateId);
          
          if (updateError) throw updateError;
        }
        
        // Generate frame overlay (extracts theme layers + opacity + FONTS)
        if (templateId) {
          const skipThumbnail = document.getElementById('skip_thumbnail').checked;
          
          setLoading(true, 'Generating frame overlay...');
          const overlayResponse = await fetch(FRAME_OVERLAY_FUNCTION_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({ template_id: templateId })
          });
          
          const overlayResult = await overlayResponse.json();
          
          if (!overlayResponse.ok || !overlayResult.success) {
            // Show partial success
            showStatus(`Template saved but frame overlay generation failed: ${overlayResult.error || 'Unknown error'}. You can retry later.`, false, overlayResult);
            setLoading(false);
            return;
          }
          
          // Show font status from overlay result
          if (overlayResult.fonts) {
            showFontStatus(overlayResult.fonts);
          }
          
          let thumbnailMsg = '';
          let thumbnailResult = null;
          
          // Only generate thumbnail if not skipping (fast sync uses Templated.io's preview)
          if (!skipThumbnail) {
            setLoading(true, 'Generating thumbnail...');
            const thumbnailResponse = await fetch(THUMBNAIL_FUNCTION_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              },
              body: JSON.stringify({ template_id: templateId })
            });
            
            thumbnailResult = await thumbnailResponse.json();
            
            if (!thumbnailResponse.ok || !thumbnailResult.success) {
              thumbnailMsg = ` Thumbnail generation failed: ${thumbnailResult.error || 'Unknown error'}.`;
            } else {
              thumbnailMsg = ' Thumbnail generated with default colors.';
            }
          } else {
            thumbnailMsg = ' Using Templated.io preview (fast sync).';
          }
          
          // Success message with details
          const themeCount = overlayResult.stats?.themeLayers || 0;
          const fontCount = overlayResult.fonts?.total || 0;
          let msg = `Template "${name}" saved successfully!`;
          if (themeCount > 0) {
            msg += ` ${themeCount} theme layer(s) detected.`;
          }
          if (fontCount > 0) {
            msg += ` ${fontCount} font(s) registered.`;
          }
          msg += ` Default BG: ${defaultBgColor}${defaultThemeColor ? `, Theme: ${defaultThemeColor}` : ''}.`;
          msg += thumbnailMsg;
          
          showStatus(msg, true, { overlay: overlayResult, thumbnail: thumbnailResult });
          
          // Clear form for new template mode
          if (currentMode === 'new') {
            document.getElementById('templated_id').value = '';
            document.getElementById('name').value = '';
          }
          
          // Refresh existing templates dropdown
          if (currentMode === 'existing') {
            await loadExistingTemplates();
          }
          
        } else {
          showStatus('Template synced but could not generate overlay (missing template ID). Please try again.', false);
        }
        
      } catch (error) {
        console.error('Error:', error);
        showStatus(error.message || 'An error occurred', false);
      } finally {
        setLoading(false);
      }
    });

    // Batch thumbnail regeneration
    async function regenerateAllThumbnails() {
      const btn = document.getElementById('batchBtn');
      const btnText = document.getElementById('batchBtnText');
      const spinner = document.getElementById('batchSpinner');
      const status = document.getElementById('batchStatus');
      
      btn.disabled = true;
      btnText.textContent = 'Regenerating...';
      spinner.classList.remove('hidden');
      status.classList.add('hidden');
      
      try {
        const response = await fetch(THUMBNAIL_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ generate_all: true })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Batch regeneration failed');
        }
        
        // Show results
        const successCount = result.successCount || 0;
        const failCount = result.failCount || 0;
        const total = result.totalProcessed || 0;
        
        status.className = 'mt-3 text-sm p-3 rounded-lg ' + (failCount === 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300');
        status.innerHTML = `
          <p class="font-medium">‚úÖ Batch complete!</p>
          <p>Processed: ${total} templates</p>
          <p>Success: ${successCount} | Failed: ${failCount}</p>
          ${result.results ? `<details class="mt-2"><summary class="cursor-pointer text-xs">View details</summary><pre class="mt-1 text-xs overflow-auto p-2 bg-black/10 rounded max-h-40">${JSON.stringify(result.results, null, 2)}</pre></details>` : ''}
        `;
        status.classList.remove('hidden');
        
      } catch (error) {
        console.error('Batch regeneration error:', error);
        status.className = 'mt-3 text-sm p-3 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
        status.innerHTML = `<p class="font-medium">‚ùå Error</p><p>${error.message}</p>`;
        status.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Regenerate All Thumbnails';
        spinner.classList.add('hidden');
      }
    }

    // Dark mode detection
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }

    // Check auth on load
    checkAuth();
  </script>
</body>
</html>
